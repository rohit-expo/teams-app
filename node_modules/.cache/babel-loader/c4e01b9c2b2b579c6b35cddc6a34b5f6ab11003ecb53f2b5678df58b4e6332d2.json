{"ast":null,"code":"/*! @azure/msal-common v13.2.0 2023-07-05 */\n'use strict';\n\nimport { __extends, __awaiter, __generator, __assign } from '../_virtual/_tslib.js';\nimport { BaseClient } from './BaseClient.js';\nimport { RequestParameterBuilder } from '../request/RequestParameterBuilder.js';\nimport { AuthenticationScheme, GrantType, HeaderNames, Errors } from '../utils/Constants.js';\nimport { ResponseHandler } from '../response/ResponseHandler.js';\nimport { PopTokenGenerator } from '../crypto/PopTokenGenerator.js';\nimport { StringUtils } from '../utils/StringUtils.js';\nimport { ClientConfigurationError } from '../error/ClientConfigurationError.js';\nimport { ClientAuthError } from '../error/ClientAuthError.js';\nimport { ServerError } from '../error/ServerError.js';\nimport { TimeUtils } from '../utils/TimeUtils.js';\nimport { UrlString } from '../url/UrlString.js';\nimport { CcsCredentialType } from '../account/CcsCredential.js';\nimport { buildClientInfoFromHomeAccountId } from '../account/ClientInfo.js';\nimport { InteractionRequiredAuthError, InteractionRequiredAuthErrorMessage } from '../error/InteractionRequiredAuthError.js';\nimport { PerformanceEvents } from '../telemetry/performance/PerformanceEvent.js';\n\n/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\n/**\r\n * OAuth2.0 refresh token client\r\n */\nvar RefreshTokenClient = /** @class */function (_super) {\n  __extends(RefreshTokenClient, _super);\n  function RefreshTokenClient(configuration, performanceClient) {\n    return _super.call(this, configuration, performanceClient) || this;\n  }\n  RefreshTokenClient.prototype.acquireToken = function (request) {\n    var _a, _b, _c, _d, _e, _f, _g;\n    return __awaiter(this, void 0, void 0, function () {\n      var atsMeasurement, reqTimestamp, response, httpVerToken, requestId, responseHandler;\n      var _this = this;\n      return __generator(this, function (_h) {\n        switch (_h.label) {\n          case 0:\n            (_a = this.performanceClient) === null || _a === void 0 ? void 0 : _a.addQueueMeasurement(PerformanceEvents.RefreshTokenClientAcquireToken, request.correlationId);\n            atsMeasurement = (_b = this.performanceClient) === null || _b === void 0 ? void 0 : _b.startMeasurement(PerformanceEvents.RefreshTokenClientAcquireToken, request.correlationId);\n            this.logger.verbose(\"RefreshTokenClientAcquireToken called\", request.correlationId);\n            reqTimestamp = TimeUtils.nowSeconds();\n            (_c = this.performanceClient) === null || _c === void 0 ? void 0 : _c.setPreQueueTime(PerformanceEvents.RefreshTokenClientExecuteTokenRequest, request.correlationId);\n            return [4 /*yield*/, this.executeTokenRequest(request, this.authority)];\n          case 1:\n            response = _h.sent();\n            httpVerToken = (_d = response.headers) === null || _d === void 0 ? void 0 : _d[HeaderNames.X_MS_HTTP_VERSION];\n            atsMeasurement === null || atsMeasurement === void 0 ? void 0 : atsMeasurement.addStaticFields({\n              refreshTokenSize: ((_e = response.body.refresh_token) === null || _e === void 0 ? void 0 : _e.length) || 0\n            });\n            if (httpVerToken) {\n              atsMeasurement === null || atsMeasurement === void 0 ? void 0 : atsMeasurement.addStaticFields({\n                httpVerToken: httpVerToken\n              });\n            }\n            requestId = (_f = response.headers) === null || _f === void 0 ? void 0 : _f[HeaderNames.X_MS_REQUEST_ID];\n            responseHandler = new ResponseHandler(this.config.authOptions.clientId, this.cacheManager, this.cryptoUtils, this.logger, this.config.serializableCache, this.config.persistencePlugin);\n            responseHandler.validateTokenResponse(response.body);\n            (_g = this.performanceClient) === null || _g === void 0 ? void 0 : _g.setPreQueueTime(PerformanceEvents.HandleServerTokenResponse, request.correlationId);\n            return [2 /*return*/, responseHandler.handleServerTokenResponse(response.body, this.authority, reqTimestamp, request, undefined, undefined, true, request.forceCache, requestId).then(function (result) {\n              atsMeasurement === null || atsMeasurement === void 0 ? void 0 : atsMeasurement.endMeasurement({\n                success: true\n              });\n              return result;\n            }).catch(function (error) {\n              _this.logger.verbose(\"Error in fetching refresh token\", request.correlationId);\n              atsMeasurement === null || atsMeasurement === void 0 ? void 0 : atsMeasurement.endMeasurement({\n                errorCode: error.errorCode,\n                subErrorCode: error.subError,\n                success: false\n              });\n              throw error;\n            })];\n        }\n      });\n    });\n  };\n  /**\r\n   * Gets cached refresh token and attaches to request, then calls acquireToken API\r\n   * @param request\r\n   */\n  RefreshTokenClient.prototype.acquireTokenByRefreshToken = function (request) {\n    var _a, _b, _c, _d;\n    return __awaiter(this, void 0, void 0, function () {\n      var isFOCI, noFamilyRTInCache, clientMismatchErrorWithFamilyRT;\n      return __generator(this, function (_e) {\n        // Cannot renew token if no request object is given.\n        if (!request) {\n          throw ClientConfigurationError.createEmptyTokenRequestError();\n        }\n        (_a = this.performanceClient) === null || _a === void 0 ? void 0 : _a.addQueueMeasurement(PerformanceEvents.RefreshTokenClientAcquireTokenByRefreshToken, request.correlationId);\n        // We currently do not support silent flow for account === null use cases; This will be revisited for confidential flow usecases\n        if (!request.account) {\n          throw ClientAuthError.createNoAccountInSilentRequestError();\n        }\n        isFOCI = this.cacheManager.isAppMetadataFOCI(request.account.environment);\n        // if the app is part of the family, retrive a Family refresh token if present and make a refreshTokenRequest\n        if (isFOCI) {\n          try {\n            (_b = this.performanceClient) === null || _b === void 0 ? void 0 : _b.setPreQueueTime(PerformanceEvents.RefreshTokenClientAcquireTokenWithCachedRefreshToken, request.correlationId);\n            return [2 /*return*/, this.acquireTokenWithCachedRefreshToken(request, true)];\n          } catch (e) {\n            noFamilyRTInCache = e instanceof InteractionRequiredAuthError && e.errorCode === InteractionRequiredAuthErrorMessage.noTokensFoundError.code;\n            clientMismatchErrorWithFamilyRT = e instanceof ServerError && e.errorCode === Errors.INVALID_GRANT_ERROR && e.subError === Errors.CLIENT_MISMATCH_ERROR;\n            // if family Refresh Token (FRT) cache acquisition fails or if client_mismatch error is seen with FRT, reattempt with application Refresh Token (ART)\n            if (noFamilyRTInCache || clientMismatchErrorWithFamilyRT) {\n              (_c = this.performanceClient) === null || _c === void 0 ? void 0 : _c.setPreQueueTime(PerformanceEvents.RefreshTokenClientAcquireTokenWithCachedRefreshToken, request.correlationId);\n              return [2 /*return*/, this.acquireTokenWithCachedRefreshToken(request, false)];\n              // throw in all other cases\n            } else {\n              throw e;\n            }\n          }\n        }\n        // fall back to application refresh token acquisition\n        (_d = this.performanceClient) === null || _d === void 0 ? void 0 : _d.setPreQueueTime(PerformanceEvents.RefreshTokenClientAcquireTokenWithCachedRefreshToken, request.correlationId);\n        return [2 /*return*/, this.acquireTokenWithCachedRefreshToken(request, false)];\n      });\n    });\n  };\n  /**\r\n   * makes a network call to acquire tokens by exchanging RefreshToken available in userCache; throws if refresh token is not cached\r\n   * @param request\r\n   */\n  RefreshTokenClient.prototype.acquireTokenWithCachedRefreshToken = function (request, foci) {\n    var _a, _b, _c;\n    return __awaiter(this, void 0, void 0, function () {\n      var atsMeasurement, refreshToken, refreshTokenRequest;\n      return __generator(this, function (_d) {\n        (_a = this.performanceClient) === null || _a === void 0 ? void 0 : _a.addQueueMeasurement(PerformanceEvents.RefreshTokenClientAcquireTokenWithCachedRefreshToken, request.correlationId);\n        atsMeasurement = (_b = this.performanceClient) === null || _b === void 0 ? void 0 : _b.startMeasurement(PerformanceEvents.RefreshTokenClientAcquireTokenWithCachedRefreshToken, request.correlationId);\n        this.logger.verbose(\"RefreshTokenClientAcquireTokenWithCachedRefreshToken called\", request.correlationId);\n        refreshToken = this.cacheManager.getRefreshToken(request.account, foci);\n        if (!refreshToken) {\n          atsMeasurement === null || atsMeasurement === void 0 ? void 0 : atsMeasurement.discardMeasurement();\n          throw InteractionRequiredAuthError.createNoTokensFoundError();\n        }\n        // attach cached RT size to the current measurement\n        atsMeasurement === null || atsMeasurement === void 0 ? void 0 : atsMeasurement.endMeasurement({\n          success: true\n        });\n        refreshTokenRequest = __assign(__assign({}, request), {\n          refreshToken: refreshToken.secret,\n          authenticationScheme: request.authenticationScheme || AuthenticationScheme.BEARER,\n          ccsCredential: {\n            credential: request.account.homeAccountId,\n            type: CcsCredentialType.HOME_ACCOUNT_ID\n          }\n        });\n        (_c = this.performanceClient) === null || _c === void 0 ? void 0 : _c.setPreQueueTime(PerformanceEvents.RefreshTokenClientAcquireToken, request.correlationId);\n        return [2 /*return*/, this.acquireToken(refreshTokenRequest)];\n      });\n    });\n  };\n  /**\r\n   * Constructs the network message and makes a NW call to the underlying secure token service\r\n   * @param request\r\n   * @param authority\r\n   */\n  RefreshTokenClient.prototype.executeTokenRequest = function (request, authority) {\n    var _a, _b, _c;\n    return __awaiter(this, void 0, void 0, function () {\n      var acquireTokenMeasurement, queryParametersString, endpoint, requestBody, headers, thumbprint;\n      return __generator(this, function (_d) {\n        switch (_d.label) {\n          case 0:\n            (_a = this.performanceClient) === null || _a === void 0 ? void 0 : _a.addQueueMeasurement(PerformanceEvents.RefreshTokenClientExecuteTokenRequest, request.correlationId);\n            acquireTokenMeasurement = (_b = this.performanceClient) === null || _b === void 0 ? void 0 : _b.startMeasurement(PerformanceEvents.RefreshTokenClientExecuteTokenRequest, request.correlationId);\n            (_c = this.performanceClient) === null || _c === void 0 ? void 0 : _c.setPreQueueTime(PerformanceEvents.RefreshTokenClientCreateTokenRequestBody, request.correlationId);\n            queryParametersString = this.createTokenQueryParameters(request);\n            endpoint = UrlString.appendQueryString(authority.tokenEndpoint, queryParametersString);\n            return [4 /*yield*/, this.createTokenRequestBody(request)];\n          case 1:\n            requestBody = _d.sent();\n            headers = this.createTokenRequestHeaders(request.ccsCredential);\n            thumbprint = {\n              clientId: this.config.authOptions.clientId,\n              authority: authority.canonicalAuthority,\n              scopes: request.scopes,\n              claims: request.claims,\n              authenticationScheme: request.authenticationScheme,\n              resourceRequestMethod: request.resourceRequestMethod,\n              resourceRequestUri: request.resourceRequestUri,\n              shrClaims: request.shrClaims,\n              sshKid: request.sshKid\n            };\n            return [2 /*return*/, this.executePostToTokenEndpoint(endpoint, requestBody, headers, thumbprint).then(function (result) {\n              acquireTokenMeasurement === null || acquireTokenMeasurement === void 0 ? void 0 : acquireTokenMeasurement.endMeasurement({\n                success: true\n              });\n              return result;\n            }).catch(function (error) {\n              acquireTokenMeasurement === null || acquireTokenMeasurement === void 0 ? void 0 : acquireTokenMeasurement.endMeasurement({\n                success: false\n              });\n              throw error;\n            })];\n        }\n      });\n    });\n  };\n  /**\r\n   * Helper function to create the token request body\r\n   * @param request\r\n   */\n  RefreshTokenClient.prototype.createTokenRequestBody = function (request) {\n    var _a, _b, _c;\n    return __awaiter(this, void 0, void 0, function () {\n      var correlationId, acquireTokenMeasurement, parameterBuilder, clientAssertion, popTokenGenerator, reqCnfData, clientInfo;\n      return __generator(this, function (_d) {\n        switch (_d.label) {\n          case 0:\n            (_a = this.performanceClient) === null || _a === void 0 ? void 0 : _a.addQueueMeasurement(PerformanceEvents.RefreshTokenClientCreateTokenRequestBody, request.correlationId);\n            correlationId = request.correlationId;\n            acquireTokenMeasurement = (_b = this.performanceClient) === null || _b === void 0 ? void 0 : _b.startMeasurement(PerformanceEvents.BaseClientCreateTokenRequestHeaders, correlationId);\n            parameterBuilder = new RequestParameterBuilder();\n            parameterBuilder.addClientId(this.config.authOptions.clientId);\n            parameterBuilder.addScopes(request.scopes);\n            parameterBuilder.addGrantType(GrantType.REFRESH_TOKEN_GRANT);\n            parameterBuilder.addClientInfo();\n            parameterBuilder.addLibraryInfo(this.config.libraryInfo);\n            parameterBuilder.addApplicationTelemetry(this.config.telemetry.application);\n            parameterBuilder.addThrottling();\n            if (this.serverTelemetryManager) {\n              parameterBuilder.addServerTelemetry(this.serverTelemetryManager);\n            }\n            parameterBuilder.addCorrelationId(correlationId);\n            parameterBuilder.addRefreshToken(request.refreshToken);\n            if (this.config.clientCredentials.clientSecret) {\n              parameterBuilder.addClientSecret(this.config.clientCredentials.clientSecret);\n            }\n            if (this.config.clientCredentials.clientAssertion) {\n              clientAssertion = this.config.clientCredentials.clientAssertion;\n              parameterBuilder.addClientAssertion(clientAssertion.assertion);\n              parameterBuilder.addClientAssertionType(clientAssertion.assertionType);\n            }\n            if (!(request.authenticationScheme === AuthenticationScheme.POP)) return [3 /*break*/, 2];\n            popTokenGenerator = new PopTokenGenerator(this.cryptoUtils, this.performanceClient);\n            (_c = this.performanceClient) === null || _c === void 0 ? void 0 : _c.setPreQueueTime(PerformanceEvents.PopTokenGenerateCnf, request.correlationId);\n            return [4 /*yield*/, popTokenGenerator.generateCnf(request)];\n          case 1:\n            reqCnfData = _d.sent();\n            // SPA PoP requires full Base64Url encoded req_cnf string (unhashed)\n            parameterBuilder.addPopToken(reqCnfData.reqCnfString);\n            return [3 /*break*/, 3];\n          case 2:\n            if (request.authenticationScheme === AuthenticationScheme.SSH) {\n              if (request.sshJwk) {\n                parameterBuilder.addSshJwk(request.sshJwk);\n              } else {\n                acquireTokenMeasurement === null || acquireTokenMeasurement === void 0 ? void 0 : acquireTokenMeasurement.endMeasurement({\n                  success: false\n                });\n                throw ClientConfigurationError.createMissingSshJwkError();\n              }\n            }\n            _d.label = 3;\n          case 3:\n            if (!StringUtils.isEmptyObj(request.claims) || this.config.authOptions.clientCapabilities && this.config.authOptions.clientCapabilities.length > 0) {\n              parameterBuilder.addClaims(request.claims, this.config.authOptions.clientCapabilities);\n            }\n            if (this.config.systemOptions.preventCorsPreflight && request.ccsCredential) {\n              switch (request.ccsCredential.type) {\n                case CcsCredentialType.HOME_ACCOUNT_ID:\n                  try {\n                    clientInfo = buildClientInfoFromHomeAccountId(request.ccsCredential.credential);\n                    parameterBuilder.addCcsOid(clientInfo);\n                  } catch (e) {\n                    this.logger.verbose(\"Could not parse home account ID for CCS Header: \" + e);\n                  }\n                  break;\n                case CcsCredentialType.UPN:\n                  parameterBuilder.addCcsUpn(request.ccsCredential.credential);\n                  break;\n              }\n            }\n            acquireTokenMeasurement === null || acquireTokenMeasurement === void 0 ? void 0 : acquireTokenMeasurement.endMeasurement({\n              success: true\n            });\n            return [2 /*return*/, parameterBuilder.createQueryString()];\n        }\n      });\n    });\n  };\n  return RefreshTokenClient;\n}(BaseClient);\nexport { RefreshTokenClient };","map":{"version":3,"mappings":"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","names":["__extends","RefreshTokenClient","performanceClient","_super","request","addQueueMeasurement","PerformanceEvents","RefreshTokenClientAcquireToken","correlationId","atsMeasurement","startMeasurement","logger","verbose","reqTimestamp","TimeUtils","nowSeconds","setPreQueueTime","RefreshTokenClientExecuteTokenRequest","executeTokenRequest","authority","response","_h","httpVerToken","headers","HeaderNames","X_MS_HTTP_VERSION","addStaticFields","refreshTokenSize","body","refresh_token","length","requestId","X_MS_REQUEST_ID","responseHandler","ResponseHandler","config","authOptions","clientId","cacheManager","cryptoUtils","serializableCache","persistencePlugin","validateTokenResponse","HandleServerTokenResponse","handleServerTokenResponse","undefined","forceCache","then","result","endMeasurement","success","catch","error","_this","errorCode","subErrorCode","subError","ClientConfigurationError","createEmptyTokenRequestError","RefreshTokenClientAcquireTokenByRefreshToken","account","ClientAuthError","createNoAccountInSilentRequestError","isFOCI","isAppMetadataFOCI","environment","RefreshTokenClientAcquireTokenWithCachedRefreshToken","acquireTokenWithCachedRefreshToken","e","noFamilyRTInCache","InteractionRequiredAuthError","InteractionRequiredAuthErrorMessage","noTokensFoundError","code","clientMismatchErrorWithFamilyRT","ServerError","Errors","INVALID_GRANT_ERROR","CLIENT_MISMATCH_ERROR","foci","refreshToken","getRefreshToken","discardMeasurement","createNoTokensFoundError","refreshTokenRequest","secret","authenticationScheme","AuthenticationScheme","BEARER","ccsCredential","credential","homeAccountId","type","CcsCredentialType","HOME_ACCOUNT_ID","acquireToken","acquireTokenMeasurement","RefreshTokenClientCreateTokenRequestBody","queryParametersString","createTokenQueryParameters","endpoint","UrlString","appendQueryString","tokenEndpoint","createTokenRequestBody","requestBody","_d","createTokenRequestHeaders","thumbprint","canonicalAuthority","scopes","claims","resourceRequestMethod","resourceRequestUri","shrClaims","sshKid","executePostToTokenEndpoint","BaseClientCreateTokenRequestHeaders","parameterBuilder","RequestParameterBuilder","addClientId","addScopes","addGrantType","GrantType","REFRESH_TOKEN_GRANT","addClientInfo","addLibraryInfo","libraryInfo","addApplicationTelemetry","telemetry","application","addThrottling","serverTelemetryManager","addServerTelemetry","addCorrelationId","addRefreshToken","clientCredentials","clientSecret","addClientSecret","clientAssertion","addClientAssertion","assertion","addClientAssertionType","assertionType","POP","popTokenGenerator","PopTokenGenerator","PopTokenGenerateCnf","generateCnf","reqCnfData","addPopToken","reqCnfString","SSH","sshJwk","addSshJwk","createMissingSshJwkError","StringUtils","isEmptyObj","clientCapabilities","addClaims","systemOptions","preventCorsPreflight","clientInfo","buildClientInfoFromHomeAccountId","addCcsOid","UPN","addCcsUpn","createQueryString","BaseClient"],"sources":["D:\\teams-app\\qlik2\\Microsoft-Teams-Samples\\samples\\tab-personal-sso-quickstart\\js\\node_modules\\@azure\\msal-common\\src\\client\\RefreshTokenClient.ts"],"sourcesContent":["/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\r\n\r\nimport { ClientConfiguration } from \"../config/ClientConfiguration\";\r\nimport { BaseClient } from \"./BaseClient\";\r\nimport { CommonRefreshTokenRequest } from \"../request/CommonRefreshTokenRequest\";\r\nimport { Authority } from \"../authority/Authority\";\r\nimport { ServerAuthorizationTokenResponse } from \"../response/ServerAuthorizationTokenResponse\";\r\nimport { RequestParameterBuilder } from \"../request/RequestParameterBuilder\";\r\nimport { GrantType, AuthenticationScheme, Errors, HeaderNames } from \"../utils/Constants\";\r\nimport { ResponseHandler } from \"../response/ResponseHandler\";\r\nimport { AuthenticationResult } from \"../response/AuthenticationResult\";\r\nimport { PopTokenGenerator } from \"../crypto/PopTokenGenerator\";\r\nimport { StringUtils } from \"../utils/StringUtils\";\r\nimport { RequestThumbprint } from \"../network/RequestThumbprint\";\r\nimport { NetworkResponse } from \"../network/NetworkManager\";\r\nimport { CommonSilentFlowRequest } from \"../request/CommonSilentFlowRequest\";\r\nimport { ClientConfigurationError } from \"../error/ClientConfigurationError\";\r\nimport { ClientAuthError } from \"../error/ClientAuthError\";\r\nimport { ServerError } from \"../error/ServerError\";\r\nimport { TimeUtils } from \"../utils/TimeUtils\";\r\nimport { UrlString } from \"../url/UrlString\";\r\nimport { CcsCredentialType } from \"../account/CcsCredential\";\r\nimport { buildClientInfoFromHomeAccountId } from \"../account/ClientInfo\";\r\nimport { InteractionRequiredAuthError, InteractionRequiredAuthErrorMessage } from \"../error/InteractionRequiredAuthError\";\r\nimport { PerformanceEvents } from \"../telemetry/performance/PerformanceEvent\";\r\nimport { IPerformanceClient } from \"../telemetry/performance/IPerformanceClient\";\r\n/**\r\n * OAuth2.0 refresh token client\r\n */\r\nexport class RefreshTokenClient extends BaseClient {\r\n    constructor(configuration: ClientConfiguration, performanceClient?: IPerformanceClient) {\r\n        super(configuration, performanceClient);\r\n\r\n    }\r\n    public async acquireToken(request: CommonRefreshTokenRequest): Promise<AuthenticationResult> {\r\n        this.performanceClient?.addQueueMeasurement(PerformanceEvents.RefreshTokenClientAcquireToken, request.correlationId);\r\n\r\n        const atsMeasurement = this.performanceClient?.startMeasurement(PerformanceEvents.RefreshTokenClientAcquireToken, request.correlationId);\r\n        this.logger.verbose(\"RefreshTokenClientAcquireToken called\", request.correlationId);\r\n        const reqTimestamp = TimeUtils.nowSeconds();\r\n        this.performanceClient?.setPreQueueTime(PerformanceEvents.RefreshTokenClientExecuteTokenRequest, request.correlationId);\r\n        const response = await this.executeTokenRequest(request, this.authority);\r\n        const httpVerToken = response.headers?.[HeaderNames.X_MS_HTTP_VERSION];\r\n        atsMeasurement?.addStaticFields({\r\n            refreshTokenSize: response.body.refresh_token?.length || 0,\r\n        });\r\n        if(httpVerToken)\r\n        {\r\n            atsMeasurement?.addStaticFields({\r\n                httpVerToken,\r\n            });\r\n        }\r\n\r\n        // Retrieve requestId from response headers\r\n        const requestId = response.headers?.[HeaderNames.X_MS_REQUEST_ID];\r\n        const responseHandler = new ResponseHandler(\r\n            this.config.authOptions.clientId,\r\n            this.cacheManager,\r\n            this.cryptoUtils,\r\n            this.logger,\r\n            this.config.serializableCache,\r\n            this.config.persistencePlugin\r\n        );\r\n        responseHandler.validateTokenResponse(response.body);\r\n\r\n        this.performanceClient?.setPreQueueTime(PerformanceEvents.HandleServerTokenResponse, request.correlationId);\r\n        return responseHandler.handleServerTokenResponse(\r\n            response.body,\r\n            this.authority,\r\n            reqTimestamp,\r\n            request,\r\n            undefined,\r\n            undefined,\r\n            true,\r\n            request.forceCache,\r\n            requestId\r\n        ).then((result: AuthenticationResult) => {\r\n            atsMeasurement?.endMeasurement({\r\n                success: true\r\n            });\r\n            return result;\r\n        })\r\n            .catch((error) => {\r\n                this.logger.verbose(\"Error in fetching refresh token\", request.correlationId);\r\n                atsMeasurement?.endMeasurement({\r\n                    errorCode: error.errorCode,\r\n                    subErrorCode: error.subError,\r\n                    success: false\r\n                });\r\n                throw error;\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Gets cached refresh token and attaches to request, then calls acquireToken API\r\n     * @param request\r\n     */\r\n    public async acquireTokenByRefreshToken(request: CommonSilentFlowRequest): Promise<AuthenticationResult> {\r\n        // Cannot renew token if no request object is given.\r\n        if (!request) {\r\n            throw ClientConfigurationError.createEmptyTokenRequestError();\r\n        }\r\n\r\n        this.performanceClient?.addQueueMeasurement(PerformanceEvents.RefreshTokenClientAcquireTokenByRefreshToken, request.correlationId);\r\n\r\n        // We currently do not support silent flow for account === null use cases; This will be revisited for confidential flow usecases\r\n        if (!request.account) {\r\n            throw ClientAuthError.createNoAccountInSilentRequestError();\r\n        }\r\n\r\n        // try checking if FOCI is enabled for the given application\r\n        const isFOCI = this.cacheManager.isAppMetadataFOCI(request.account.environment);\r\n\r\n        // if the app is part of the family, retrive a Family refresh token if present and make a refreshTokenRequest\r\n        if (isFOCI) {\r\n            try {\r\n                this.performanceClient?.setPreQueueTime(PerformanceEvents.RefreshTokenClientAcquireTokenWithCachedRefreshToken, request.correlationId);\r\n                return this.acquireTokenWithCachedRefreshToken(request, true);\r\n            } catch (e) {\r\n                const noFamilyRTInCache = e instanceof InteractionRequiredAuthError && e.errorCode === InteractionRequiredAuthErrorMessage.noTokensFoundError.code;\r\n                const clientMismatchErrorWithFamilyRT = e instanceof ServerError && e.errorCode === Errors.INVALID_GRANT_ERROR && e.subError === Errors.CLIENT_MISMATCH_ERROR;\r\n\r\n                // if family Refresh Token (FRT) cache acquisition fails or if client_mismatch error is seen with FRT, reattempt with application Refresh Token (ART)\r\n                if (noFamilyRTInCache || clientMismatchErrorWithFamilyRT) {\r\n                    this.performanceClient?.setPreQueueTime(PerformanceEvents.RefreshTokenClientAcquireTokenWithCachedRefreshToken, request.correlationId);\r\n                    return this.acquireTokenWithCachedRefreshToken(request, false);\r\n                    // throw in all other cases\r\n                } else {\r\n                    throw e;\r\n                }\r\n            }\r\n        }\r\n        // fall back to application refresh token acquisition\r\n        this.performanceClient?.setPreQueueTime(PerformanceEvents.RefreshTokenClientAcquireTokenWithCachedRefreshToken, request.correlationId);\r\n        return this.acquireTokenWithCachedRefreshToken(request, false);\r\n\r\n    }\r\n\r\n    /**\r\n     * makes a network call to acquire tokens by exchanging RefreshToken available in userCache; throws if refresh token is not cached\r\n     * @param request\r\n     */\r\n    private async acquireTokenWithCachedRefreshToken(request: CommonSilentFlowRequest, foci: boolean) {\r\n        this.performanceClient?.addQueueMeasurement(PerformanceEvents.RefreshTokenClientAcquireTokenWithCachedRefreshToken, request.correlationId);\r\n\r\n        // fetches family RT or application RT based on FOCI value\r\n\r\n        const atsMeasurement = this.performanceClient?.startMeasurement(PerformanceEvents.RefreshTokenClientAcquireTokenWithCachedRefreshToken, request.correlationId);\r\n        this.logger.verbose(\"RefreshTokenClientAcquireTokenWithCachedRefreshToken called\", request.correlationId);\r\n        const refreshToken = this.cacheManager.getRefreshToken(request.account, foci);\r\n\r\n        if (!refreshToken) {\r\n            atsMeasurement?.discardMeasurement();\r\n            throw InteractionRequiredAuthError.createNoTokensFoundError();\r\n        }\r\n        // attach cached RT size to the current measurement\r\n        atsMeasurement?.endMeasurement({\r\n            success: true\r\n        });\r\n\r\n        const refreshTokenRequest: CommonRefreshTokenRequest = {\r\n            ...request,\r\n            refreshToken: refreshToken.secret,\r\n            authenticationScheme: request.authenticationScheme || AuthenticationScheme.BEARER,\r\n            ccsCredential: {\r\n                credential: request.account.homeAccountId,\r\n                type: CcsCredentialType.HOME_ACCOUNT_ID\r\n            }\r\n        };\r\n\r\n        this.performanceClient?.setPreQueueTime(PerformanceEvents.RefreshTokenClientAcquireToken, request.correlationId);\r\n        return this.acquireToken(refreshTokenRequest);\r\n    }\r\n\r\n    /**\r\n     * Constructs the network message and makes a NW call to the underlying secure token service\r\n     * @param request\r\n     * @param authority\r\n     */\r\n    private async executeTokenRequest(request: CommonRefreshTokenRequest, authority: Authority)\r\n        : Promise<NetworkResponse<ServerAuthorizationTokenResponse>> {\r\n        this.performanceClient?.addQueueMeasurement(PerformanceEvents.RefreshTokenClientExecuteTokenRequest, request.correlationId);\r\n        const acquireTokenMeasurement = this.performanceClient?.startMeasurement(PerformanceEvents.RefreshTokenClientExecuteTokenRequest, request.correlationId);\r\n        this.performanceClient?.setPreQueueTime(PerformanceEvents.RefreshTokenClientCreateTokenRequestBody, request.correlationId);\r\n        \r\n        const queryParametersString = this.createTokenQueryParameters(request);\r\n        const endpoint = UrlString.appendQueryString(authority.tokenEndpoint, queryParametersString);\r\n        \r\n        const requestBody = await this.createTokenRequestBody(request);\r\n        const headers: Record<string, string> = this.createTokenRequestHeaders(request.ccsCredential);\r\n        const thumbprint: RequestThumbprint = {\r\n            clientId: this.config.authOptions.clientId,\r\n            authority: authority.canonicalAuthority,\r\n            scopes: request.scopes,\r\n            claims: request.claims,\r\n            authenticationScheme: request.authenticationScheme,\r\n            resourceRequestMethod: request.resourceRequestMethod,\r\n            resourceRequestUri: request.resourceRequestUri,\r\n            shrClaims: request.shrClaims,\r\n            sshKid: request.sshKid\r\n        };\r\n\r\n        return this.executePostToTokenEndpoint(endpoint, requestBody, headers, thumbprint)\r\n            .then((result) => {\r\n                acquireTokenMeasurement?.endMeasurement({\r\n                    success: true\r\n                });\r\n                return result;\r\n            })\r\n            .catch((error) => {\r\n                acquireTokenMeasurement?.endMeasurement({\r\n                    success: false\r\n                });\r\n                throw error;\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Helper function to create the token request body\r\n     * @param request\r\n     */\r\n    private async createTokenRequestBody(request: CommonRefreshTokenRequest): Promise<string> {\r\n        this.performanceClient?.addQueueMeasurement(PerformanceEvents.RefreshTokenClientCreateTokenRequestBody, request.correlationId);\r\n\r\n        const correlationId = request.correlationId;\r\n        const acquireTokenMeasurement = this.performanceClient?.startMeasurement(PerformanceEvents.BaseClientCreateTokenRequestHeaders, correlationId);\r\n        const parameterBuilder = new RequestParameterBuilder();\r\n\r\n        parameterBuilder.addClientId(this.config.authOptions.clientId);\r\n\r\n        parameterBuilder.addScopes(request.scopes);\r\n\r\n        parameterBuilder.addGrantType(GrantType.REFRESH_TOKEN_GRANT);\r\n\r\n        parameterBuilder.addClientInfo();\r\n\r\n        parameterBuilder.addLibraryInfo(this.config.libraryInfo);\r\n        parameterBuilder.addApplicationTelemetry(this.config.telemetry.application);\r\n        parameterBuilder.addThrottling();\r\n\r\n        if (this.serverTelemetryManager) {\r\n            parameterBuilder.addServerTelemetry(this.serverTelemetryManager);\r\n        }\r\n\r\n        parameterBuilder.addCorrelationId(correlationId);\r\n\r\n        parameterBuilder.addRefreshToken(request.refreshToken);\r\n\r\n        if (this.config.clientCredentials.clientSecret) {\r\n            parameterBuilder.addClientSecret(this.config.clientCredentials.clientSecret);\r\n        }\r\n\r\n        if (this.config.clientCredentials.clientAssertion) {\r\n            const clientAssertion = this.config.clientCredentials.clientAssertion;\r\n            parameterBuilder.addClientAssertion(clientAssertion.assertion);\r\n            parameterBuilder.addClientAssertionType(clientAssertion.assertionType);\r\n        }\r\n\r\n        if (request.authenticationScheme === AuthenticationScheme.POP) {\r\n            const popTokenGenerator = new PopTokenGenerator(this.cryptoUtils, this.performanceClient);\r\n            this.performanceClient?.setPreQueueTime(PerformanceEvents.PopTokenGenerateCnf, request.correlationId);\r\n            const reqCnfData = await popTokenGenerator.generateCnf(request);\r\n            // SPA PoP requires full Base64Url encoded req_cnf string (unhashed)\r\n            parameterBuilder.addPopToken(reqCnfData.reqCnfString);\r\n        } else if (request.authenticationScheme === AuthenticationScheme.SSH) {\r\n            if (request.sshJwk) {\r\n                parameterBuilder.addSshJwk(request.sshJwk);\r\n            } else {\r\n                acquireTokenMeasurement?.endMeasurement({\r\n                    success: false\r\n                });\r\n                throw ClientConfigurationError.createMissingSshJwkError();\r\n            }\r\n        }\r\n\r\n        if (!StringUtils.isEmptyObj(request.claims) || this.config.authOptions.clientCapabilities && this.config.authOptions.clientCapabilities.length > 0) {\r\n            parameterBuilder.addClaims(request.claims, this.config.authOptions.clientCapabilities);\r\n        }\r\n\r\n        if (this.config.systemOptions.preventCorsPreflight && request.ccsCredential) {\r\n            switch (request.ccsCredential.type) {\r\n                case CcsCredentialType.HOME_ACCOUNT_ID:\r\n                    try {\r\n                        const clientInfo = buildClientInfoFromHomeAccountId(request.ccsCredential.credential);\r\n                        parameterBuilder.addCcsOid(clientInfo);\r\n                    } catch (e) {\r\n                        this.logger.verbose(\"Could not parse home account ID for CCS Header: \" + e);\r\n                    }\r\n                    break;\r\n                case CcsCredentialType.UPN:\r\n                    parameterBuilder.addCcsUpn(request.ccsCredential.credential);\r\n                    break;\r\n            }\r\n        }\r\n        acquireTokenMeasurement?.endMeasurement({\r\n            success: true\r\n        });\r\n        return parameterBuilder.createQueryString();\r\n    }\r\n}\r\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}